apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "spire.fullname" . }}-update-bss
  labels:
    app.kubernetes.io/name: {{ template "spire.name" . }}-update-bss
    {{- include "spire.common-labels" . | nindent 4 }}
spec:
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ template "spire.name" . }}-update-bss
    spec:
      containers:
        - name: {{ template "spire.name" . }}-update-bss
          image: "{{ include "spire.image-prefix" . }}{{ .Values.bss.curl.repository }}:{{ .Values.bss.curl.tag }}"
          command:
            - '/bin/sh'
            - '-x'
            - '-c'
          args:
            - 'retries=1;
               while ! curl -fv --request PATCH -H "Content-Type: application/json" -d @/conf/bss-update.json "$ENDPOINT";
                 do if [ $retries -gt 9 ];
                   then echo "Failed to add spire entry to BSS";
                   exit 1;
                 fi;
                 echo "Failed to patch BSS. Retrying ($retries/10)";
                 retries=$(expr $retries + 1);
                 sleep 30;
               done'
          env:
            - name: ENDPOINT
              value: "{{ .Values.bss.endpoint }}"
          volumeMounts:
            - name: conf
              mountPath: /conf
              readOnly: true
      restartPolicy: OnFailure
      volumes:
        - name: conf
          configMap:
            name: spire-bss-config
